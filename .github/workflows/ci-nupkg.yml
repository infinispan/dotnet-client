name: infinispan-nupkg
env:
  ISPN_VER: "13.0.10.Final"
on:
  push:
    tags:
      - "*"
    branches:
      - '9.2.x'
jobs:
  run-ci-nupkg:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4
      - run: echo $GITHUB_REF_NAME
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1
        with:
          msbuild-architecture: x64
      #        with:
      #          vs-version: "[17.0,17.2)"
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      #- uses: actions/setup-python@v4
      #  with:
      #    python-version: "3.x" # Version range or exact version of a Python version to use, using SemVer's version range syntax
      #    architecture: "x64" # optional x64 or x86. Defaults to x64 if not specified
      - name: Setup nuget
        uses: nuget/setup-nuget@v1
      - name: Find Tag
        id: tagger
        uses: jimschubert/query-tag-action@v1
        with:
          include: '9.2.*'
#      - name: Set tag
#        run: |
#          pwd
#          git describe --tag
#          $tg = & git describe --tag
#          "CLIENT_VERSION=$tg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Build C#
        shell: pwsh
        env:
          buildTag: "${{ env.GITHUB_REF_NAME }}.latest"
        run: |
          .\build.ps1 QuickPack
      #- name: Build C#
      #  shell: cmd
      #  run: |
      #    echo '::echo::on'
      #    where swig
      #    where mvn
      #    where java
      #    dir
      #    set generator="Visual Studio 17 2022"
      #    set checkoutDir=${{ github.workspace }}
      #    set INFINISPAN_VERSION=13.0.10.Final
      #    set JBOSS_HOME=${{ github.workspace }}\cpp-client\infinispan-server-13.0.10.Final
      #    set PROTOBUF_LIBRARY=${{ github.workspace }}\libs\lib\libprotobuf.lib
      #    set PROTOBUF_PROTOC_EXECUTABLE=${{ github.workspace }}\libs\bin\protoc.exe
      #    set PROTOBUF_PROTOC_LIBRARY=${{ github.workspace }}\libs\lib\libprotoc.lib
      #    set PROTOBUF_INCLUDE_DIR=${{ github.workspace }}\protobuf\src
      #    set HOTROD_SNK=${{ github.workspace }}\strongNames.key
      #    powershell -file "build.ps1" "QuickPack"
      - uses: ncipollo/release-action@v1
        with:
          artifacts: "src/Infinispan.HotRod/bin/RelWithDebInfo/*.nupkg"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          tag: ${{ env.GITHUB_REF_NAME }}.latest